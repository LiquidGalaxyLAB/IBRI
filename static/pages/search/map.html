{% extends 'templatebase.html' %}

{% load static %}

{% block title %}
    Map Search
{% endblock %}

{% block main %}


    <div class="col-xs-12 col-md-8">
        <div class="card card-body" style="padding: 20px;">
            <div id="map" style="min-height: 450px; width: 100%; border:1px solid #d5d5d5;"></div>

            <div style="float: right;">



                <button type="button" id="cleanButton" class="btn btn-success btn-lg"><i class="fa fa-times"> Stop and Clear</i></button>
                <button type="button" id="startbutton" class="btn btn-success btn-lg"><i class="fa fa-search"> Start Search</i></button>
            </div>

            <div class="" id="div_userList">
                <table id="userList" class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>NIF</th>
                            <th>Beacon</th>
                            <th>Search</th>
                        </tr>
                    </thead>
                    <tbody>
                       {% for c in client %}
                        <tr>
                            <td>{{ c.name }} {{ c.lastname }}</td>
                            <td>{{ c.nif }}</td>
                            <td>{{ c.physicalCode }}</td>
                            <td><input type="checkbox" name="searching" value="{{ c.id }}" /> #{{ c.id }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th>User</th>
                            <th>NIF</th>
                            <th>Beacon</th>
                            <th>Search</th>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div id="resultPanel">

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <div class="title">Result Panel</div>
                        </div>
                    </div>
                    <div class="card-body" id="resultUserList">
                    </div>

                </div>


            </div>


        </div>
    </div>





    <div class="col-xs-12 col-md-4">


        <div class="row" style="padding: 0px;">

                <div class="col-lg-12" >
                    <div id="climatologyContainer" class="card blue summary-inline">
                        <div class="card-body">
                            <i class="icon fa fa-cloud fa-3x"></i>
                            <div class="content">
                                <div class="title" id="climatologyWind">Climatology</div>
                                <div class="sub-title" id="climatologyDesc"></div>
                            </div>
                            <div class="clear-both"></div>
                        </div>
                    </div>
                </div>



            </div>



        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="title">Settings</div>
                </div>
            </div>
            <div class="card-body">

                <div class="form-group">
                    <label for="distance">Distance between points (in meters)</label>
                    <input type="text" class="form-control" id="distance" placeholder="Enter distance (in meters)" value="100">
                </div>
                <div class="form-group">
                    <label for="gridsize">Grid side size (square)</label>
                    <input type="text" class="form-control" id="gridSize" placeholder="Enter grid size" value="5">
                </div>

                <div class="form-group">
                    <label for="gridsize">No Drones</label>
                    <input type="text" class="form-control" id="nodrone" placeholder="Enter drone number" value="1">
                </div>

            </div>
        </div>



        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <div class="title">Demos</div>
                </div>
            </div>
            <div class="card-body">

                <button type="button" demo="1" class="btn col-lg-12 btn-info demobutton"><i class="fa fa-map-marker"> 1d Demo 1 - Mercedes</i></button>
                <button type="button" demo="2" class="btn col-lg-12 btn-info demobutton"><i class="fa fa-map-marker"> 1d Demo 2 Ravelo</i></button>
                <button type="button" demo="3" class="btn col-lg-12 btn-info demobutton"><i class="fa fa-map-marker"> 2d Demo 3 Cañadas</i></button>
                <button type="button" demo="4" class="btn col-lg-12 btn-info demobutton"><i class="fa fa-map-marker"> 3d Demo 4 La Laguna</i></button>
                <button type="button" demo="5" class="btn col-lg-12 btn-info demobutton"><i class="fa fa-map-marker"> 5d Demo 5 Las Américas</i></button>

            </div>

        </div>




    </div>





{% endblock %}

{% block extrajs %}

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js"></script>
    <script type="text/javascript" src="{% static 'js/gmaps.js' %}"></script>

    <!-- DataTables -->
    <script src="{% static 'dist/lib/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'dist/lib/js/dataTables.bootstrap.min.js' %}"></script>


  <script type="text/javascript" src="{% static 'js/distances.js' %}"></script>

  <script type="text/javascript" src="{% static 'js/components/core.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/rollups/aes.js' %}"></script>


  <script type="text/javascript">
$(document).ready(function(){

    var key = CryptoJS.enc.Utf8.parse('preshared_key012'); // 16 bits!

    function encrypt(msgString, key) {
        // msgString is expected to be Utf8 encoded
        var iv = CryptoJS.lib.WordArray.random(16);
        var encrypted = CryptoJS.AES.encrypt(msgString, key, {
            iv: iv
        });
        return iv.concat(encrypted.ciphertext).toString(CryptoJS.enc.Base64);
    }

    function decrypt(ciphertextStr, key) {
        var ciphertext = CryptoJS.enc.Base64.parse(ciphertextStr);

        // split IV and ciphertext
        var iv = ciphertext.clone();
        iv.sigBytes = 16;
        iv.clamp();
        ciphertext.words.splice(0, 4); // delete 4 words = 16 bytes
        ciphertext.sigBytes -= 16;

        // decryption
        var decrypted = CryptoJS.AES.decrypt({ciphertext: ciphertext}, key, {
            iv: iv
        });
        return decrypted.toString(CryptoJS.enc.Utf8);
    }

    //console.log(encrypt('hola caracola', key));

        var map;
        var baseCoords = [28.4812865, -16.3205404];
        var markerArray = [];
        var selected = null;
        var zone = 0;
        var colorList = [
            '#D32F2F',
            '#303F9F',
            '#4CAF50',
            '#F57C00',
            '#FF4081',
            '#1976D2',
            '#8BC34A',
            '#E64A19',
            '#E040FB',
            '#0097A7',
            '#FBC02D',
            '#FBC02D'
        ];
        var demos = [ // base, center_area, area_size, noDrones, find
            [28.519179, -16.296779, 28.522681, -16.302325, 7, 1],
            [28.456487, -16.388333, 28.457496, -16.387464, 5, 1],
            [28.297621, -16.567193, 28.296875, -16.574094, 5, 2],
            [28.482389, -16.322115, 28.483314, -16.322426, 8, 3],
            [28.061228, -16.729034, 28.059474, -16.726670, 7, 5],
        ];
        var c = null;
        var posArrays = [];
        //var drone = -1;
        var response = null;
        var tmpMarker = [];

        $(".demobutton").click(function() {

            $("#cleanButton").click();

            demoNum = parseInt($(this).attr('demo')) - 1;

            baseCoords[0] = demos[demoNum][0];
            baseCoords[1] = demos[demoNum][1];

            addBase();

            $("#gridSize").val(demos[demoNum][4]);
            $("#nodrone").val(demos[demoNum][5]);

            var d = {
                latLng: {
                    lat() {
                        return demos[demoNum][2];
                    },
                    lng() {
                        return demos[demoNum][3];
                    }
                }
            };

            map.setCenter(baseCoords[0], baseCoords[1]);
            checkWeather(d);

        });


        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                }
            }
        });


        $("#cleanButton").click(function(){
            markerArray = [];
            tmpMarker = [];
            posArrays = [];
            map.removeMarkers();
            map.removePolylines();
            map.removePolygons();
            clearInterval(response);
            addBase();
            $("#startbutton").prop("disabled", false);

            $("#resultPanel").fadeOut();
            $("#resultPanel").html();
            $("#userList").fadeIn();


        });

        //calculates distance between two points in km's
        function calcDistance(p1, p2) {
            return (google.maps.geometry.spherical.computeDistanceBetween(p1, p2) / 1000).toFixed(2);
        }



        $("#startbutton").click(function() {
            if (parseInt($("#gridSize").val()) > 25) {
                alert("El tiempo de cálculo para este tipo de tamaños puede ser muy grande.");
                return 0;
            }

            if (parseInt($("#nodrone").val()) <= 0) {
                alert("Debe establecer al menos un dron");
                return 0;
            }

            if (markerArray.length == 0) {
                alert("Seleccione un punto en el mapa para establecer una zona de búsqueda");
                return false;
            }

            if ($("#nodrone").val() > markerArray.length) {
                alert("De momento no es posible establecer más drones que el tamaño de lado del grid");
                return false;
            }

            selected = $("input[type='checkbox'][name='searching']:checked").map(function() {
                return this.value;
            }).get();

            if (selected.length <= 0) {
                alert("Debe seleccionar a un usuario en búsqueda");
                return false;
            }

            $(this).attr('disabled', 'true');

            $("#userList").fadeOut();
            $("#resultPanel").fadeIn();

            for (i = 0; i < selected.length; i++) {
                $("#resultUserList").append('<div id="photo_' + selected[i] + '"></div>');
            }


            distNear = [];
            nearToBase = [];


            nodesPerDrone = Math.floor((markerArray.length * markerArray.length) / $("#nodrone").val());
            dispersion = [];
            for (i = 0; i < $("#nodrone").val(); i++) {
                distNear.push(9999);
                nearToBase.push(0);
                posArrays.push([]);
                dispersion.push(nodesPerDrone);
            }

            map.removePolylines();

            resto = (markerArray.length * markerArray.length) - (nodesPerDrone *  $("#nodrone").val());
            console.log(resto);
            for(i = 0; i < resto; i++){
                dispersion[i]++;
            }

            console.log(dispersion);

            //---------------------------------------------------------------------------------------------------------- //----------------------------------------------------------------------------------------------------------


            drone = 0;
            x = 0;
            c = 0;
            n = 0;

            for (var mX = 0; mX < markerArray.length; mX++) {
                for (var mY = 0; mY < markerArray[mX].length; mY++) {

                    if(drone < c){
                        n = x-1;
                    }else if(drone == c){
                        if(c == 0)
                            c = c + dispersion[x]-1
                        else
                            c = c + dispersion[x]
                        x++
                    }

                    if (zone == 1 || zone == 2) {
                        lat = markerArray[mY][mX].internalPosition.lat();
                        lng = markerArray[mY][mX].internalPosition.lng();
                    } else {
                        lat = markerArray[mX][mY].internalPosition.lat();
                        lng = markerArray[mX][mY].internalPosition.lng();
                    }

                    posArrays[n].push([lat, lng]);
                    drone++;

                    p1 = new google.maps.LatLng(lat, lng);
                    p2 = new google.maps.LatLng(baseCoords[0], baseCoords[1]);

                    distancePoint = calcDistance(p1, p2) * 1000;
                    if (distancePoint < distNear[n]) {
                        distNear[n] = distancePoint;
                        nearToBase[n] = [mX, mY];
                    }

                }
            }

            console.log();

            $.ajax({
                type: "POST",
                url: "{% url 'createRoute' %}",
                data: {

                    msg: encrypt(JSON.stringify({
                        ndrones: $("#nodrone").val(),
                        insearch: JSON.stringify(selected),
                        nearPoint: JSON.stringify(nearToBase),
                        distance: $("#distance").val(),
                        wayPoints: JSON.stringify(posArrays),
                        base: JSON.stringify(baseCoords)
                    }), key)

                    /*ndrones: $("#nodrone").val(),
                    insearch: JSON.stringify(selected),
                    nearPoint: JSON.stringify(nearToBase),
                    distance: $("#distance").val(),
                    wayPoints: JSON.stringify(posArrays),
                    base: JSON.stringify(baseCoords)*/
                },
                success: function(data) {

                    data = JSON.parse(decrypt(data, key));
                    mission = data[0];
                    data = data[1];
                    datal = data.length;

                    for (i = 0; i < datal; i++) {
                        map.drawPolyline({
                            path: data[i],
                            strokeColor: colorList[i % colorList.length],
                            strokeOpacity: 0.6,
                            strokeWeight: 4
                        });

                        map.drawPolyline({
                            path: [
                                [baseCoords[0], baseCoords[1]], data[i][0]
                            ],
                            strokeColor: colorList[i % colorList.length],
                            strokeOpacity: 0.4,
                            strokeWeight: 4
                        });

                    }

                    waitForResponse(mission);

                }
            });


        });

        function checkWeather(e) {

            if ($("#startbutton").is(':disabled')) {
                return 0;
            }

            weatherMapApi = '9e439c5eea0e0f086de6503b1295ca8e';
            url = 'http://api.openweathermap.org/data/2.5/weather?units=metric&lat=' + e.latLng.lat() + '&lon=' + e.latLng.lng() + '&appid=' + weatherMapApi;

            $.ajax({
                async: false,
                type: "POST",
                url: url,
                dataType: "json",
                success: function(response) {

                    console.log(response);
                    console.log("Viento: " + response.wind.speed);
                    console.log("LAT: " + e.latLng.lat() + ', ' + 'LNG: ' + e.latLng.lng());
                    if (response.wind.speed >= 10) {
                        alert("Las condiciones climatologicas no permiten el vuelo de drones en esta zona.");
                        $("#climatologyContainer").removeClass('blue');
                        $("#climatologyContainer").addClass('red');
                        return false;
                    }

                    setGrid(e);

                    $("#climatologyWind").html(response.wind.speed+" km/h");
                    $("#climatologyDesc").html(response.weather[0].description);

                },
                error: function(response) {
                    alert("Hubo un error al recuperar los datos de información meteorológica.");
                    return false;
                }

            });

        }

        function listToMatrix(list, elementsPerSubArray) {
            // http://stackoverflow.com/questions/4492385/
            var matrix = [],
                i, k;
            for (i = 0, k = -1; i < list.length; i++) {
                if (i % elementsPerSubArray === 0) {
                    k++;
                    matrix[k] = [];
                }
                matrix[k].push(list[i]);
            }
            return matrix;
        }

        function addBase() {
            map.addMarker({
                lat: baseCoords[0],
                lng: baseCoords[1],
                icon: "{% static 'img/red.png' %}",
                infoWindow: {
                    content: '<p>Base</p>'
                }
            });
            map.removePolygons();
            c = map.drawCircle({
                lat: baseCoords[0],
                lng: baseCoords[1],
                radius: parseInt($("#distance").val()),
                fillColor: 'blue',
                fillOpacity: 0.2,
                strokeWeight: 0,
                click: function(e) {
                    checkWeather(e);
                }
            });

        }

        function isInArray(value, array) {
            return array.indexOf(value) > -1;
        }


        function waitForResponse(missionId) {

            response = setInterval(function() {

                $.ajax({
                    type: "POST",
                    url: "{% url 'getTracking' %}",
                    data: {
                        mId: missionId
                    },
                    success: function(data) {

                        map.removeMarkers();
                        data = JSON.parse(decrypt(data, key));
                        console.log(missionId);

                        console.log(data.length);
                        console.log(data);

                        for (i = 0; i < data.length; i++) {

                            for (j = 0; j < data[i].length; j++) {

                                if (data[i][j][4] != null) {

                                    icon = "{% static 'img/physical_demo_signal.png' %}"


                                    if (isInArray((data[i][j][4]).toString(), selected)) {
                                        icon = "{% static 'img/beacon.png' %}"
                                    }

                                    map.addMarker({
                                        lat: data[i][j][1],
                                        lng: data[i][j][2],
                                        icon: icon,
                                        infoWindow: {
                                            content: '<p>BEACON: ' + data[i][j][4] + '</p>'
                                        }
                                    });
                                }

                                if (data[i][j][5] != null) {
                                    $("#photo_" + data[i][j][4]).html('<img src="data:image/png;base64,' + data[i][j][5] + '" />');
                                }

                                map.removeMarker(tmpMarker[i]);
                                console.log("DATA: " + data[i][data[i].length - 1]);
                                console.log(data[i]);
                                tmpMarker[i] = map.addMarker({
                                    lat: data[i][data[i].length - 1][1],
                                    lng: data[i][data[i].length - 1][2],
                                    icon: "{% static 'img/drone32x32.png' %}"
                                });
                                map.zoomIn(1);
                                map.zoomOut(1);

                            }

                        }

                    }
                });
            }, 6000);

        }

        function setGrid(e){

            if(parseInt($("#gridSize").val()) > 25){
                alert("El grid debe tener como tamaño máximo un valor de 25");
                return 0;
            }

            map.removeMarkers();
            addBase();
            markerArray = [];

            clickLat = e.latLng.lat()
            clickLng = e.latLng.lng()
            distance = parseInt($("#distance").val());
            sideSize = parseInt($("#gridSize").val());

            tmp = distanceTo(clickLat, clickLng, (distance * ((sideSize-1) / 2)) , 180);
            tmp = distanceTo(tmp[0], tmp[1], (distance * ((sideSize-1) / 2)) , 90);

            clickLat = tmp[0];
            clickLng = tmp[1];

            for(i = 0; i < sideSize; i++){
                for(j = 0; j < sideSize; j++){

                    distanceI = distance * i;
                    distanceJ = distance * j;

                    p = distanceTo(clickLat, clickLng, distanceI, 0);
                    p = distanceTo(p[0], p[1], distanceJ, 270);

                    markerArray.push(map.createMarker({
                      lat: p[0],
                      lng: p[1],
                      details: {'pos' : [i, j], 'danger' : 0, 'visited': 0},
                      icon: "{% static 'img/grey_recortado.png' %}"
                    }));

                }
            }


            map.addMarkers(markerArray);
            markerArray = listToMatrix(markerArray, sideSize);

            console.log(markerArray);

            halfSide = parseInt(Math.floor(sideSize/2));

            pBase = new google.maps.LatLng(baseCoords[0], baseCoords[1]);

            zone = 0;
            tmpDist = calcDistance(pBase, markerArray[halfSide][0].position);


            if(calcDistance(pBase, markerArray[0][halfSide].position) < tmpDist){
                zone = 1;
                tmpDist = calcDistance(pBase, markerArray[0][halfSide].position);
            }

            if(calcDistance(pBase, markerArray[sideSize-1][0].position) < tmpDist){
                zone = 2;
                tmpDist = calcDistance(pBase, markerArray[sideSize-1][0].position);
            }

            if(calcDistance(pBase, markerArray[0][sideSize-1].position) < tmpDist){
                zone = 3;
                tmpDist = calcDistance(pBase, markerArray[0][sideSize-1].position);
            }

            console.log(zone);


        }


      map = new GMaps({
          el: '#map',
          lat: 28.4812865,
          lng: -16.3205404,
          zoomControl: true,
          zoomControlOpt: {
              style: 'SMALL',
              position: 'TOP_LEFT'
          },
          click: function(e) {
              checkWeather(e);
              //setGrid(e);
          },
          panControl: false,
          streetViewControl: false,
          mapTypeControl: true,
          overviewMapControl: false
      });

      map.setContextMenu({
          control: 'map',
          options: [{
              title: 'Set drone base position',
              name: 'add_marker',
              action: function(e) {
                  map.removeMarkers();
                  markerArray = [];
                  baseCoords[0] = e.latLng.lat();
                  baseCoords[1] = e.latLng.lng();
                  addBase();
              }
          }, {
              title: 'Center here',
              name: 'center_here',
              action: function(e) {
                  this.setCenter(e.latLng.lat(), e.latLng.lng());
              }
          }]
      });


      addBase();


      $('#userList').DataTable({

      });


      // using jQuery
      function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie != '') {
              var cookies = document.cookie.split(';');
              for (var i = 0; i < cookies.length; i++) {
                  var cookie = jQuery.trim(cookies[i]);
                  // Does this cookie string begin with the name we want?
                  if (cookie.substring(0, name.length + 1) == (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }


    });

  </script>

{% endblock %}